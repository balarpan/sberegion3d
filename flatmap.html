<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<title>СБЕРБАНК. Потенциал лесопромышленного комплекса.</title>
<link rel="stylesheet" href='css/style.css'>
<script type="text/javascript" src='js/jquery-3.2.1.min.js'></script>
<script type="text/javascript" src='js/qryBuilder.js'></script>
<style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #homeDiv {
      left: 15px;
      top: 130px;
      z-index: 35;
      position: absolute;
    }
</style>

<script type="text/javascript">
var config = {
  // regionRF: "http://services.arcgis.com/HOo89W8RWwrXP286/arcgis/rest/services/GeoFIAS_2016_08/FeatureServer/0"
  regionRF: "https://services.arcgis.com/HOo89W8RWwrXP286/ArcGIS/rest/services/Regions_RF/FeatureServer/1",
  regionDetailed: "https://services.arcgis.com/HOo89W8RWwrXP286/ArcGIS/rest/services/Regions_RF/FeatureServer/0",
  regionCompanies: "https://services.arcgis.com/HOo89W8RWwrXP286/ArcGIS/rest/services/Regions_RF/FeatureServer/2",
  globeView: location.search.match(/globeView=([\w\-]+)/) ? RegExp.$1==true : false,
  regionCode: location.search.match(/regionCode=([\w\-]+)/) ? parseInt(RegExp.$1) : false,
  callParams:{},
}
location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(s,k,v){config.callParams[k]=v})

var path_location = location.href.replace(/\/[^/]+$/, '');
var dojoConfig = {
  // look for a locale=xx query string param, else default to 'en-us'
  locale: location.search.match(/locale=([\w\-]+)/) ? RegExp.$1 : "en-us",
  // packages: [{
  //   name: "config",
  //   location: path_location + '/config'
  // }]

};
</script>
<link rel="stylesheet" href="https://js.arcgis.com/4.4/esri/css/main.css">
<script src="https://js.arcgis.com/4.4/"></script>

</head>
<body>

  <div style="display:none">
    <div id="goHome" class="esri-widget-button esri-widget esri-interactive" title="Показать весь регион" style="margin:0; border-top: solid 1px rgba(50,50,50,0.25); "> <span aria-hidden="true" role="presentation" class="esri-icon esri-icon-home"></span><span class="esri-icon-font-fallback-text">Показать весь регион</span> </div>
    <div id="goCompanies" class="esri-widget-button esri-widget esri-interactive" title="Все компании региона" style="margin:0; border-top: solid 1px rgba(50,50,50,0.25);"> <span aria-hidden="true" role="presentation" class="esri-icon esri-icon-maps"></span><span class="esri-icon-font-fallback-text">Все компании региона</span> </div>
    <div id="goBack3D" class="esri-widget-button esri-widget esri-interactive" title="К 3D карте" style="border-top: solid 1px rgba(50,50,50,0.25);"> <span aria-hidden="true" role="presentation" class="esri-icon esri-icon-globe"></span><span class="esri-icon-font-fallback-text">К 3D карте</span> </div>
  </div>
  <div id="header"><span><u>СБЕРБАНК</u> <span style='color:#fff'> &gt;&gt; ПОТЕНЦИАЛ ЛЕСОПРОМЫШЛЕННОГО КОМПЛЕКСА</span></span> <div id="headerDate"></div></div>
  <div id="headerAfter"></div>
  <div id="viewDiv">
    <div id="mapLoadingProgress" class='mapLoadingProgress progress-line' "></div>
  </div>
  <div id="homeDiv"></div>

<script type="text/javascript">
'use strict'

$('#headerDate').text( new Date().toJSON().slice(0,10).split('-').reverse().join('.') );

require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/core/watchUtils", "esri/renderers/SimpleRenderer", "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleMarkerSymbol",
  "esri/Basemap","esri/layers/TileLayer", "esri/widgets/Legend",
  "esri/widgets/Expand", "esri/widgets/BasemapGallery",
  "dojo/domReady!"
], function(Map, MapView, FeatureLayer,
  watchUtils, SimpleRenderer, SimpleFillSymbol, SimpleMarkerSymbol,
  Basemap, TileLayer, Legend,
  Expand, BasemapGallery
) {

  var companiesPopupTemplate = { // autocasts as new PopupTemplate()
    title: "<b>{Наиме} ({City})</b>",
    content: "<b>Название организации:</b> {Наиме}<br>" +
      "<b>ИНН:</b> {ИНН}<br>" +
      "<b>Адрес:</b> {Адрес}<br>" +
      "<b>Регион:</b> {RegionName} ({RegionCode})<br>" +
      "<i>{FederalSubject}</i><br><br>",
    fieldInfos: [{
      fieldName: "SPUD",
      format: {
        dateFormat: "short-date"
      }
    }, {
      fieldName: "COMPLETION",
      format: {
        dateFormat: "short-date"
      }
    }, {
      fieldName: "RegionCode",
      format: {
        places: 0,
        digitSeparator: false
      }
    }]
  };

  var borderRender = new SimpleRenderer({
    label: "Границы региона",
    symbol: new SimpleFillSymbol({
      color: [ 205, 219, 202, 0.5 ], style: "solid", outline:{
        color: "222222", width: 0.5
      }
    })
  })
  var regionsRFLyr = new FeatureLayer({
    url: config.regionDetailed,
    // definitionExpression: "Status = 'CBM' OR Status = 'EOR' OR Status = 'GAS' OR Status = 'INJ' OR Status = 'O&G' OR Status = 'OIL' OR Status = 'SWD'",
    outFields: ["*"],
    definitionExpression: 'RegionCode='+config.regionCode,
    renderer: borderRender
  });

  var companiesRender = new SimpleRenderer({
    label: "Производство",
    symbol: new SimpleMarkerSymbol({
      color:"#FF4000",
      outline: { color:[255, 64, 0, 0.4], width:5}
    }),
    size: "8px",
  })
  var companiesLyr = new FeatureLayer({
    url: config.regionCompanies,
    // definitionExpression: "Status = 'CBM' OR Status = 'EOR' OR Status = 'GAS' OR Status = 'INJ' OR Status = 'O&G' OR Status = 'OIL' OR Status = 'SWD'",
    outFields: ["*"],
    definitionExpression: 'RegionCode='+config.regionCode,
    popupTemplate: companiesPopupTemplate,
    renderer: companiesRender,
  });
  var russiaExtent = {
    xmax: 20037507, xmin: 2226522,
    ymax: 16854341, ymin: 2216059,
    spatialReference: { // autocasts as new SpatialReference()
      wkid: 3857
    }
  };
  var pkk5Basemap = new Basemap({
    baseLayers: [
      new TileLayer({url:"http://pkk5.rosreestr.ru/arcgis/rest/services/BaseMaps/BaseMap/MapServer"}),
      // new TileLayer({url:"https://pkk5.rosreestr.ru/arcgis/rest/services/BaseMaps/Anno/MapServer"}),
    ],
    title: "Базовая карта РФ",
    id: "pkk5"
  });


  var map = new Map({
    basemap: "topo",
    // basemap: pkk5Basemap,
    layers: [regionsRFLyr, companiesLyr ]
  });

  var view = new MapView({
    map: map,
    container: "viewDiv",
    constraints: { rotationEnabled: false },
    extent: russiaExtent
  });

//   var actionBtns = [
//     {id:'goHome', func:function(e){ e.stopPropagation(); window.location.href='./index.html?' + $.param(config.callParams);} },
//     {id:'goBack3D', func:function(e){ e.stopPropagation(); window.location.href='./index.html?' + $.param(config.callParams);} },
//   ];
//   for (var btn in actionBtns ) {
//     view.ui.add( btn.id, 'top-left' );
//     watchUtils.watch(view, "ready", function(){ $('#'+btn.id).click( btn.func ) });  
// }
  view.ui.add( {component: 'goHome', position:'top-left', index:1 });
  watchUtils.watch(view, "ready", function(){
    $('#goHome').click(function(e){ e.stopPropagation(); if (window.myExtent) view.goTo(window.myExtent); })
  });
  view.ui.add( {component: 'goCompanies', position:'top-left', index:2 } );
  watchUtils.watch(view, "ready", function(){
    $('#goCompanies').click(function(e){ e.stopPropagation(); if (window.myCompaniesExtent) view.goTo(window.myCompaniesExtent); })
  });
  view.ui.add( {component: 'goBack3D', position:'top-left', index:3 } );
  watchUtils.watch(view, "ready", function(){
    $('#goBack3D').click(function(e){ e.stopPropagation(); window.location.href='./index.html?' + $.param(config.callParams)})
  });

  watchUtils.watch(view, "updating", function(){
    $("#mapLoadingProgress").stop();
    if (view.updating) 
      $("#mapLoadingProgress").show(800);
    else
      $("#mapLoadingProgress").hide();
  })
  regionsRFLyr.queryExtent().then(function(results){ window.myExtent = results.extent.expand(1.2); view.goTo(window.myExtent); });
  companiesLyr.queryExtent().then(function(results){ window.myCompaniesExtent = results.extent.expand(2); });

  QryBuilder.qryJSON(config.regionDetailed + '/query' , {
     where: 'RegionCode='+config.regionCode, outFields:'RegionName', returnGeometry:false})
  .done( function(res){
    $('#header').children().first().html("<u>СБЕРБАНК</u> <span style='color:#fff'>&nbsp;&gt;&gt;&nbsp;" + res.features[0].attributes.RegionName  + "</span>");

    var legend = new Legend({
      view: view,
      layerInfos: [{
        layer: regionsRFLyr,
        title: res.features[0].attributes.RegionName
      },
      {
        layer: companiesLyr,
        title: "Генерирующие предприятия."
      }]
    });
    view.ui.add(legend, "bottom-right");
  });
  
  //basemam toggle with expand widget
  var basemapGallery = new BasemapGallery({
    view: view,
    container: document.createElement("div")
  });
  var bgExpand = new Expand({
    view: view,
    content: basemapGallery.domNode,
    expandIconClass: "esri-icon-basemap",
    expandTooltip: "Базовая карта", autoCollapse:true,
  });
  view.ui.add(bgExpand, "top-left");

});


</script>

</body>
</html>