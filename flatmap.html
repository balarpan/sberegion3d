<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<title>СБЕРБАНК. Потенциал лесопромышленного комплекса.</title>
<link rel="stylesheet" href='css/style.css'>
<script type="text/javascript" src='js/jquery-3.2.1.min.js'></script>
<style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #homeDiv {
      left: 15px;
      top: 130px;
      z-index: 35;
      position: absolute;
    }
</style>

<script type="text/javascript">
var config = {
  // regionRF: "http://services.arcgis.com/HOo89W8RWwrXP286/arcgis/rest/services/GeoFIAS_2016_08/FeatureServer/0"
  regionRF: "https://services.arcgis.com/HOo89W8RWwrXP286/ArcGIS/rest/services/Regions_RF/FeatureServer/1",
  regionDetailed: "https://services.arcgis.com/HOo89W8RWwrXP286/ArcGIS/rest/services/Regions_RF/FeatureServer/0",
  regionCompanies: "https://services.arcgis.com/HOo89W8RWwrXP286/ArcGIS/rest/services/Regions_RF/FeatureServer/2",
  globeView: location.search.match(/globeView=([\w\-]+)/) ? RegExp.$1==true : false,
  regionCode: location.search.match(/regionCode=([\w\-]+)/) ? parseInt(RegExp.$1) : false,
}
var path_location = location.href.replace(/\/[^/]+$/, '');
var dojoConfig = {
  // look for a locale=xx query string param, else default to 'en-us'
  locale: location.search.match(/locale=([\w\-]+)/) ? RegExp.$1 : "en-us",
  // packages: [{
  //   name: "config",
  //   location: path_location + '/config'
  // }]

};
</script>
<link rel="stylesheet" href="https://js.arcgis.com/4.4/esri/css/main.css">
<script src="https://js.arcgis.com/4.4/"></script>

</head>
<body>

  <div id="viewDiv">
    <div id="mapLoadingProgress" class='mapLoadingProgress progress-line' "></div>
  </div>
  <div id="homeDiv"></div>

<script type="text/javascript">
'use strict'

require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/core/watchUtils", "esri/renderers/SimpleRenderer", "esri/symbols/SimpleFillSymbol",
  "esri/Basemap","esri/layers/TileLayer",
  "dojo/domReady!"
], function(Map, MapView, FeatureLayer,
  watchUtils, SimpleRenderer, SimpleFillSymbol,
  Basemap, TileLayer
) {

  var companiesPopupTemplate = { // autocasts as new PopupTemplate()
    title: "<b>{Наиме} ({City})</b>",
    content: "<b>Название организации:</b> {Наиме}<br>" +
      "<b>ИНН:</b> {ИНН}<br>" +
      "<b>Адрес:</b> {Адрес}<br>" +
      "<b>Регион:</b> {RegionName} ({RegionCode})<br>" +
      "<i>{FederalSubject}</i><br><br>",
    fieldInfos: [{
      fieldName: "SPUD",
      format: {
        dateFormat: "short-date"
      }
    }, {
      fieldName: "COMPLETION",
      format: {
        dateFormat: "short-date"
      }
    }, {
      fieldName: "RegionCode",
      format: {
        places: 0,
        digitSeparator: false
      }
    }]
  };

  var borderRender = new SimpleRenderer({
    label: "Границы региона",
    symbol: new SimpleFillSymbol({
      color: [ 205, 219, 202, 0.5 ], style: "solid", outline:{
        color: "000000", width: 1
      }
    })
  })

  var regionsRFLyr = new FeatureLayer({
    url: config.regionDetailed,
    // definitionExpression: "Status = 'CBM' OR Status = 'EOR' OR Status = 'GAS' OR Status = 'INJ' OR Status = 'O&G' OR Status = 'OIL' OR Status = 'SWD'",
    outFields: ["*"],
    definitionExpression: 'RegionCode='+config.regionCode,
    renderer: borderRender
  });
  var companiesLyr = new FeatureLayer({
    url: config.regionCompanies,
    // definitionExpression: "Status = 'CBM' OR Status = 'EOR' OR Status = 'GAS' OR Status = 'INJ' OR Status = 'O&G' OR Status = 'OIL' OR Status = 'SWD'",
    outFields: ["*"],
    definitionExpression: 'RegionCode='+config.regionCode,
    popupTemplate: companiesPopupTemplate,
  });
  var russiaExtent = {
    xmax: 20037507, xmin: 2226522,
    ymax: 16854341, ymin: 2216059,
    spatialReference: { // autocasts as new SpatialReference()
      wkid: 3857
    }
  };
  var a1 = new TileLayer({url:"https://pkk5.rosreestr.ru/arcgis/rest/services/BaseMaps/BaseMap/MapServer"});
  var pkk5Basemap = new Basemap({
    baseLayers: [
      a1,
      // new TileLayer({url:"https://pkk5.rosreestr.ru/arcgis/rest/services/BaseMaps/Anno/MapServer"}),
    ],
    title: "Базовая карта РФ",
    id: "pkk5"
  });


  var map = new Map({
    // basemap: "topo",
    basemap: pkk5Basemap,
    layers: [regionsRFLyr, companiesLyr ]
  });

  var view = new MapView({
    map: map,
    container: "viewDiv",
    constraints: { rotationEnabled: false },
    extent: russiaExtent
  });

});


</script>

</body>
</html>